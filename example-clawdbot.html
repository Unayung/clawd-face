<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#e0c3fc">
<title>Clawd Face + Clawdbot</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 50%, #f5d5e0 100%);
    font-family: 'Courier New', 'Menlo', monospace;
    height: 100vh; width: 100vw;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
  }
  #bot-status {
    position: fixed; top: 1rem; right: 1rem; z-index: 100;
    padding: 0.4em 1em; border-radius: 1em;
    font-size: 0.85rem;
    background: rgba(255,255,255,0.7); color: #8a7aaa;
  }
  #chat-bar {
    position: fixed; bottom: 0; left: 0; right: 0;
    display: flex; align-items: center; gap: 0.6rem;
    padding: 0.8rem 1.2rem;
    background: rgba(255,255,255,0.75);
    backdrop-filter: blur(12px);
    z-index: 50;
    border-top: 1px solid rgba(142,120,190,0.2);
  }
  #chat-input {
    flex: 1; background: rgba(255,255,255,0.7);
    border: 1px solid rgba(142,120,190,0.3);
    border-radius: 1.5rem; padding: 0.7rem 1.2rem;
    color: #4a3f5c; font-family: inherit;
    font-size: 1rem; outline: none;
  }
  #chat-input:focus { border-color: rgba(142,120,190,0.6); }
  #chat-input::placeholder { color: #a89cc0; }
  #send-btn {
    width: 42px; height: 42px; border-radius: 50%; border: none;
    background: rgba(142,120,190,0.2); color: #7a6a9a;
    font-size: 1.2rem; cursor: pointer;
    transition: background 0.2s;
  }
  #send-btn:hover { background: rgba(142,120,190,0.35); }
  #send-btn:disabled { opacity: 0.4; cursor: default; }

  /* User message bubble */
  #bubble {
    position: fixed;
    top: 8vh;
    max-width: 60vw;
    padding: 1.2em 1.8em;
    background: rgba(255,255,255,0.85);
    color: #4a3f5c;
    border-radius: 1.5em;
    font-size: clamp(0.9rem, 2.2vw, 1.5rem);
    line-height: 1.5;
    text-align: left;
    opacity: 0;
    transition: opacity 0.4s ease;
    z-index: 10;
    pointer-events: none;
    font-family: inherit;
    box-shadow: 0 4px 20px rgba(142,120,190,0.15);
  }
  #bubble.right {
    right: 4vw;
    left: auto;
  }
  #bubble.right::after {
    content: '';
    position: absolute;
    top: 50%;
    right: -18px;
    transform: translateY(-50%);
    border-top: 12px solid transparent;
    border-bottom: 12px solid transparent;
    border-left: 20px solid rgba(255,255,255,0.85);
  }
  #bubble.left {
    left: 4vw;
    right: auto;
  }
  #bubble.left::after {
    content: '';
    position: absolute;
    top: 50%;
    left: -18px;
    transform: translateY(-50%);
    border-top: 12px solid transparent;
    border-bottom: 12px solid transparent;
    border-right: 20px solid rgba(255,255,255,0.85);
  }
  #bubble.visible {
    opacity: 1;
  }
</style>
</head>
<body>

<!-- Face engine (creates window.face) -->
<script src="face.js"></script>

<!-- User message bubble -->
<div id="bubble"></div>

<!-- Status indicator -->
<div id="bot-status">Disconnected</div>

<!-- Chat input -->
<div id="chat-bar">
  <input id="chat-input" type="text" placeholder="Talk to Clawdbot..." autocomplete="off" enterkeyhint="send" />
  <button id="send-btn">➤</button>
</div>

<!-- Clawdbot integration (creates ClawdbotFace class) -->
<script src="clawdbot.js"></script>

<script>
// ── Configuration (from URL params or defaults) ──
const params = new URLSearchParams(window.location.search);

// Each device gets its own persistent session via localStorage
function getSessionKey() {
  const urlKey = params.get('session');
  if (urlKey) return urlKey;
  let key = localStorage.getItem('clawd-face-session');
  if (!key) {
    key = 'face-' + Math.random().toString(36).slice(2, 10);
    localStorage.setItem('clawd-face-session', key);
  }
  return key;
}

const CONFIG = {
  // Use wss:// for production, ws:// only for local development
  gatewayUrl: params.get('gw') || '',
  token: params.get('token') || '',
  sessionKey: getSessionKey(),
};

const statusEl = document.getElementById('bot-status');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const bubbleEl = document.getElementById('bubble');

// ── User message bubble ──
let bubbleTimeout = null;
function showBubble(text, duration) {
  clearTimeout(bubbleTimeout);
  bubbleEl.classList.remove('visible', 'left', 'right');
  const side = Math.random() < 0.5 ? 'left' : 'right';
  bubbleEl.classList.add(side);
  bubbleEl.textContent = text;
  requestAnimationFrame(() => {
    bubbleEl.classList.add('visible');
  });
  bubbleTimeout = setTimeout(() => {
    bubbleEl.classList.remove('visible');
  }, duration || 8000);
}

const bot = new ClawdbotFace({
  gatewayUrl: CONFIG.gatewayUrl,
  token: CONFIG.token,
  sessionKey: CONFIG.sessionKey,

  onConnect: () => {
    statusEl.textContent = 'Connected ✓';
    statusEl.style.color = '#59c97a';
  },
  onDisconnect: () => {
    statusEl.textContent = 'Disconnected';
    statusEl.style.color = '#e85d72';
  },
  onMessage: (text) => {
    chatInput.disabled = false;
    sendBtn.disabled = false;
  },
  onError: (error) => {
    console.error('[bot]', error);
    chatInput.disabled = false;
    sendBtn.disabled = false;
  },
});

// Connect (only if token provided)
if (CONFIG.token) {
  bot.connect();
} else {
  statusEl.textContent = 'Add ?gw=wss://your-gateway&token=YOUR_TOKEN';
  statusEl.style.color = '#f97316';
}

// ── Chat ──
function sendMessage() {
  const text = chatInput.value.trim();
  if (!text || !bot.connected) return;
  chatInput.value = '';
  chatInput.disabled = true;
  sendBtn.disabled = true;

  // Show user message as bubble
  showBubble(text, Math.max(text.length * 150, 5000));

  bot.send(text);
}

chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
sendBtn.addEventListener('click', sendMessage);
</script>

</body>
</html>
